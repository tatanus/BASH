#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_udp_nmap.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_udp_nmap"]="external internal recon"

# Main function
function run_udp_nmap() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("PORTSCAN_DIR" "TOOLS_DIR" "OUTPUT_DIR" "RECON_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files
    local _output_dirs
    _input_files=("${PORTSCAN_DIR}/spoonmap/all_live_hosts.txt")
    _output_dirs=("${PORTSCAN_DIR}/nmap" "${RECON_DIR}/ports")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "nmap" "grep" "cut" "sort"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    TARGETS_FILE="${PORTSCAN_DIR}/spoonmap/all_live_hosts.txt"
    udp_ports=(53 123 161 500 523 623 1604 1900 5333)

    info "Running targeted UDP Nmap scans on ports: ${udp_ports[*]}"

    # Loop through UDP ports and run Nmap scans
    for port in "${udp_ports[@]}"; do
        OUTPUT_FILE="${PORTSCAN_DIR}/nmap/${port}.udp"
        info "Scanning port ${port}..."
        nmap -n -v -sV -sU -p "${port}" --open -oA "${OUTPUT_FILE}" -iL "${TARGETS_FILE}"

        if [[ $? -eq 0 ]]; then
            grep open "${OUTPUT_FILE}.gnmap" | grep -v Nmap | cut -d' ' -f 2 | sort -u -V > "${RECON_DIR}/ports/${port}.udp.txt"
            info "Results saved to ${RECON_DIR}/${port}.udp.txt."
        else
            warning "Failed to scan port ${port}. Continuing with the next port."
        fi
    done

    pass "UDP Nmap scans completed."
}
