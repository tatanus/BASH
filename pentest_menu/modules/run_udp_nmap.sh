#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Validate required environment variables
validate_env_vars DATA_DIR NMAP_DIR TOOLS_DIR

# Define the input and output files
TARGETS_FILE="${DATA_DIR}/targets.txt"

# Validate the targets file
validate_file_exists "${TARGETS_FILE}"

# Define target files and ports
if [[ -f "${TOOLS_DIR}/spoonmap/all_live_hosts.txt" ]]; then
    TARGETS_FILE="${TOOLS_DIR}/spoonmap/all_live_hosts.txt"
fi

udp_ports=(53 123 161 500 523 623 1604 1900 5333)

info "Running targeted UDP Nmap scans on ports: ${udp_ports[*]}"

# Loop through UDP ports and run Nmap scans
for port in "${udp_ports[@]}"; do
    OUTPUT_FILE="${NMAP_DIR}/SCANS/${port}"
    info "Scanning port ${port}..."
    nmap -n -v -sV -sU -p "${port}" --open -oA "${OUTPUT_FILE}" -iL "${TARGETS_FILE}"

    if [[ $? -eq 0 ]]; then
        grep open "${OUTPUT_FILE}.gnmap" | grep -v Nmap | cut -d' ' -f 2 | sort -u -V > "${NMAP_DIR}/${port}.txt"
        info "Results saved to ${NMAP_DIR}/${port}.txt."
    else
        warning "Failed to scan port ${port}. Continuing with the next port."
    fi
done

success "UDP Nmap scans completed."
