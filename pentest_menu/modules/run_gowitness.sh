#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "DATA_DIR" "TEE_DIR"

# Define the input file
WEB_TARGETS_FILE="${DATA_DIR}/web.txt"

# Check if the web targets file exists
validate_file_exists "${WEB_TARGETS_FILE}"

info "Running Gowitness on web targets from ${WEB_TARGETS_FILE}..."
while IFS= read -r url; do
    host=$(echo "${url}" | cut -d'/' -f3 | cut -d':' -f1)
    output_file="${TEE_DIR}/${host}.GOWITNESS.tee"

    info "Capturing screenshot for ${url} with Gowitness..."
    gowitness single --url "${url}" --disable-logging --timeout 30s --log-level error | tee -a "${output_file}"

    if [[ $? -ne 0 ]]; then
        warning "Gowitness capture failed for ${url}. Continuing with the next target."
    else
        success "Screenshot saved to ${output_file}."
    fi
done < "${WEB_TARGETS_FILE}"

success "Gowitness captures completed for all targets."
