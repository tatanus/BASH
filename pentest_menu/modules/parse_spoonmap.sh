#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Validate required environment variables
validate_env_vars DATA_DIR NMAP_DIR TOOLS_DIR

# Ensure required environment variables are set
if [[ -z "${TOOLS_DIR}" || -z "${NMAP_DIR}" || -z "${DATA_DIR}" ]]; then
    fail "Required environment variables (TOOLS_DIR, NMAP_DIR, DATA_DIR) are not set. Please set them and try again."
    exit 1
fi

info "Parsing SpoonMap results..."

# Define the list of ports
PORTS=("21" "22" "23" "25" "53" "80" "111" "139" "389" "443" "445"
       "1090" "1098" "1099" "1433" "3300" "3306" "3389" "4243" "4444"
       "4445" "4786" "4848" "5050" "5555" "5556" "5900" "5901" "5985"
       "5986" "6129" "6379" "6970" "7000" "7001" "7002" "7003" "7004"
       "7070" "7071" "8000" "8001" "8002" "8003" "8008" "8080" "8181"
       "8443" "8686" "9000" "9001" "9002" "9003" "9012" "9100" "9503"
       "10999" "11099" "11111" "45000" "45001" "47001" "47002" "50500")

# Parse open ports and save to respective files
info "Parsing open ports and saving results..."
for port in "${PORTS[@]}"; do
    masscan_result="${TOOLS_DIR}/spoonmap/masscan_results/port${port}.xml"
    output_file="${NMAP_DIR}/${port}.txt"

    if [[ -f "${masscan_result}" ]]; then
        grep open "${masscan_result}" | cut -d'"' -f4 | sort -u -V > "${output_file}" || {
            fail "Failed to process ${masscan_result} for port ${port}."
            continue
        }
    else
        warn "Masscan result file not found for port ${port}: ${masscan_result}"
    fi
done

# Remove empty files
info "Removing empty files in ${NMAP_DIR}..."
find "${NMAP_DIR}/" -type f -size 0 -print -delete || {
    fail "Failed to remove empty files from ${NMAP_DIR}"
    exit 1
}

# Define the list of web ports
WEB_PORTS=("80" "443" "4243" "7000" "8000" "8001" "8008" "8080" "8443" "9000")
web_target_file="${DATA_DIR}/web.txt"

# Create web target list
info "Creating web target list..."

# Clear existing web target file
: > "${web_target_file}" || {
    fail "Failed to initialize web target file: ${web_target_file}"
    exit 1
}

for port in "${WEB_PORTS[@]}"; do
    file="${NMAP_DIR}/${port}.txt"
    if [[ -f "${file}" ]]; then
        sed "s/^/http:\/\//" < "${file}" | sed "s/$/:${port}/" >> "${web_target_file}" || {
            debug "Failed to add HTTP targets for port ${port}."
        }
        sed "s/^/https:\/\//" < "${file}" | sed "s/$/:${port}/" >> "${web_target_file}" || {
            debug "Failed to add HTTPS targets for port ${port}."
        }
    else
        warn "No data file found for port ${port} in ${NMAP_DIR}"
    fi
done

success "Web target list created and saved to ${web_target_file}."
