#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : parse_spoonmap.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["parse_spoonmap"]="external internal web"

# Main function
function parse_spoonmap() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("RECON_DIR" "PORTSCAN_DIR" "TOOLS_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files _output_dirs
    _input_files=("${RECON_DIR}/web.txt")
    _output_dirs=("${PORTSCAN_DIR}" "${RECON_DIR}")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "grep" "cut" "sort" "sed"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    info "Parsing SpoonMap results..."

    # Define the list of ports
    PORTS=("21" "22" "23" "25" "53" "80" "111" "139" "389" "443" "445"
           "1090" "1098" "1099" "1433" "3300" "3306" "3389" "4243" "4444"
           "4445" "4786" "4848" "5050" "5555" "5556" "5900" "5901" "5985"
           "5986" "6129" "6379" "6970" "7000" "7001" "7002" "7003" "7004"
           "7070" "7071" "8000" "8001" "8002" "8003" "8008" "8080" "8181"
           "8443" "8686" "9000" "9001" "9002" "9003" "9012" "9100" "9503"
           "10999" "11099" "11111" "45000" "45001" "47001" "47002" "50500")

    # Parse open ports and save to respective files
    info "Parsing open ports and saving results..."
    for port in "${PORTS[@]}"; do
        masscan_result="${PORTSCAN_DIR}/SPOONMAP/masscan_results/port${port}.xml"
        output_file="${PORTSCAN_DIR}/NMAP/${port}.txt"

        if [[ -f "${masscan_result}" ]]; then
            grep open "${masscan_result}" | cut -d'"' -f4 | sort -u -V > "${output_file}" || {
                fail "Failed to process ${masscan_result} for port ${port}."
                continue
            }
        else
            warn "Masscan result file not found for port ${port}: ${masscan_result}"
        fi
    done

    # Remove empty files
    info "Removing empty files in ${PORTSCAN_DIR}/NMAP..."
    find "${PORTSCAN_DIR}/NMAP" -type f -size 0 -print -delete || {
        fail "Failed to remove empty files from ${PORTSCAN_DIR}/NMAP"
    }

    # Define the list of web ports
    WEB_PORTS=("80" "443" "4243" "7000" "8000" "8001" "8008" "8080" "8443" "9000")
    web_target_file="${RECON_DIR}/web.txt"

    # Create web target list
    info "Creating web target list..."

    # Clear existing web target file
    : > "${web_target_file}" || {
        fail "Failed to initialize web target file: ${web_target_file}"
    }

    for port in "${WEB_PORTS[@]}"; do
        file="${PORTSCAN_DIR}/NMAP/${port}.txt"
        if [[ -f "${file}" ]]; then
            sed "s/^/http:\/\//" < "${file}" | sed "s/$/:${port}/" >> "${web_target_file}" || {
                debug "Failed to add HTTP targets for port ${port}."
            }
            sed "s/^/https:\/\//" < "${file}" | sed "s/$/:${port}/" >> "${web_target_file}" || {
                debug "Failed to add HTTPS targets for port ${port}."
            }
        else
            warn "No data file found for port ${port} in ${PORTSCAN_DIR}/NMAP"
        fi
    done

    pass "Web target list created and saved to ${web_target_file}."
}
