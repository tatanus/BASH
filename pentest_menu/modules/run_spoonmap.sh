#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_spoonmap.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_spoonmap"]="recon portscan"

# Main function
function run_spoonmap() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local env_vars=("DATA_DIR" "NMAP_DIR" "TOOLS_DIR")
    validate_envs "${env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local input_files=("${DATA_DIR}/targets.txt")
    local output_dirs=("${TOOLS_DIR}/spoonmap")
    validate_input_output input_files output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "python3"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define the input and output files
    TARGETS_FILE="${DATA_DIR}/targets.txt"

    # Define the output directory for spoonmap results
    SPOONMAP_DIR="${TOOLS_DIR}/spoonmap"

    info "Running Spoonmap on targets from ${TARGETS_FILE}..."
    # run spoonmap from $SPOONMAP_DIR/spoonmap.py
    python3 "${SPOONMAP_DIR}/spoonmap.py"

    if [[ $? -ne 0 ]]; then
        fail "Spoonmap execution failed."
    else
        pass "Spoonmap completed. Results saved to ${SPOONMAP_DIR}/spoonmap."
    fi
}
