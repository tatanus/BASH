#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_msf_scripts.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_msf_scripts"]="internal"

# Main function
function run_mfs_scripts() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("OUTPUT_DIR" "RECON_DIR" "PENTEST_SCRIPTS_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files
    local _output_dirs
    _input_files=("")
    _output_dirs=("${OUTPUT_DIR}/MSF")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "msfconsole" "grep" "sed" "cut"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Check if the MSF directory exists
    check_dir_readable "${PENTEST_SCRIPTS_DIR}/MSF"

    info "Preparing to run Metasploit scripts from ${MSF_DIR}..."

    # Generate the list of MSF scripts dynamically
    msf_scripts=()
    while IFS= read -r script_file; do
        # Extract the port if available, or default to -1
        port=$(grep -Eo "set RHOSTS file:${RECON_DIR}/ports/[0-9]+\.txt" "${script_file}" | sed -E "s|.*${RECON_DIR}/ports/([0-9]+)\.txt|\1|")
        [[ -z "${port}" ]] && port="-1"

        # Get script name and check output status
        script_name=$(basename "${script_file}")
        output_file="${OUTPUT_DIR}/MSF/${script_name%.rc}.tee"
        output_status="✖"
        [[ -f "${output_file}" ]] && output_status="✔"

        msf_scripts+=("${port}:${script_name}:${output_status}")
    done < <(find "${PENTEST_SCRIPTS_DIR}/MSF" -name "*.rc" | sort)

    info "Metasploit scripts found: ${#msf_scripts[@]}"

    # Run MSF script
    function run_script() {
        local port="$1"
        local script_name="$2"
        local original_script="${PENTEST_SCRIPTS_DIR}/MSF/${script_name}"

        info "Executing script ${script_name} on port ${port}..."

        # Determine the target file
        if [[ "${port}" != "-1" ]]; then
            targets_file="${RECON_DIR}/ports/${port}.txt"
            if [[ ! -s "${targets_file}" ]]; then
                warning "No targets found for port ${port}. Skipping ${script_name}."
                return
            fi
        fi

        # Create a temporary rc file with replaced paths
        local temp_script="/tmp/${script_name}.tmp"
        sed -e "s|/root/DATA/NMAP|${RECON_DIR}/ports|g" \
            -e "s|/root/DATA/TEE|${OUTPUT_DIR}/MSF|g" \
            "${original_script}" >"${temp_script}"

        # Execute the temporary Metasploit script
        msfconsole -q -r "${temp_script}"
        if [[ $? -ne 0 ]]; then
            warning "Execution failed for script ${script_name}."
        else
            pass "Script ${script_name} completed successfully."
        fi

        # Clean up the temporary file
        rm -f "${temp_script}"
    }

    # Display menu for script selection
    info "Displaying Metasploit script menu..."
    PS3="Select a script to run or choose 0 to exit: "
    select script in "${msf_scripts[@]}" "Exit"; do
        if [[ "${script}" == "Exit" || "${REPLY}" -eq 0 ]]; then
            info "Exiting Metasploit script execution."
            break
        elif [[ -n "${script}" ]]; then
            port=$(echo "${script}" | cut -d':' -f1)
            script_name=$(echo "${script}" | cut -d':' -f2)
            run_script "${port}" "${script_name}"
        else
            warning "Invalid selection. Please choose a valid script."
        fi
    done

    pass "Metasploit script execution completed."
}
