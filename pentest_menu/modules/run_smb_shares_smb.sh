#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_smb_shares_smb.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_smb_shares_nmap"]="internal"

# Define an approximate ordering
script_order["run_smb_shares_nmap"]=30

# Main function
function run_smb_shares_nmap() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("PORTSCAN_DIR" "RECON_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files
    local _output_dirs
    _input_files=("${PORTSCAN_DIR}/NMAP/445.txt")
    _output_dirs=("${PORTSCAN_DIR}/NMAP" "${RECON_DIR}")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "nmap" "grep" "tee" "awk"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define the input file for port 445
    PORT_FILE="${PORTSCAN_DIR}/NMAP/445.txt"

    info "Enumerating open SMB shares..."
    nmap -p 445 -iL "${PORT_FILE}" --script smb-enum-shares -oA "${PORTSCAN_DIR}/NMAP/smb_shares"

    pass "SMB Shares Nmap scans completed. Results saved to ${PORTSCAN_DIR}/NMAP and ${RECON_DIR}."
}
