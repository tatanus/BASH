#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "DATA_DIR" "TEE_DIR"

# Define the input file and other parameters
WEB_TARGETS_FILE="${DATA_DIR}/web.txt"
WORDLIST="/pentest/password-recovery/dictionary/Discovery/Web-Content/common.txt"
USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"

# Check if the web targets file exists
validate_file_exists "${WEB_TARGETS_FILE}"

info "Running Gobuster on web targets from ${WEB_TARGETS_FILE}..."
while IFS= read -r url; do
    host=$(echo "${url}" | cut -d'/' -f3 | cut -d':' -f1)
    output_file="${TEE_DIR}/${host}.GOBUSTER.tee"

    info "Scanning ${url} with Gobuster..."
    gobuster dir -u "${url}" -a "${USER_AGENT}" -w "${WORDLIST}" --insecuressl | tee -a "${output_file}"

    if [[ $? -ne 0 ]]; then
        warning "Gobuster scan failed for ${url}. Continuing with the next target."
    else
        success "Results saved to ${output_file}."
    fi
done < "${WEB_TARGETS_FILE}"

success "Gobuster scans completed for all targets."
