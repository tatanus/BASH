#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_gobuster.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_gobuster"]="external internal web"

# Main function
function run_gobuster() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("DATA_DIR" "TEE_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files
    local _output_dirs
    _input_files=("${DATA_DIR}/web.txt" "/pentest/password-recovery/dictionary/Discovery/Web-Content/common.txt")
    _output_dirs=("${TEE_DIR}")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "gobuster" "tee"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define the input file and other parameters
    WEB_TARGETS_FILE="${DATA_DIR}/web.txt"
    WORDLIST="/pentest/password-recovery/dictionary/Discovery/Web-Content/common.txt"
    USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"

    info "Running Gobuster on web targets from ${WEB_TARGETS_FILE}..."
    while IFS= read -r url; do
        host=$(echo "${url}" | cut -d'/' -f3 | cut -d':' -f1)
        output_file="${TEE_DIR}/${host}.GOBUSTER.tee"

        info "Scanning ${url} with Gobuster..."
        gobuster dir -u "${url}" -a "${USER_AGENT}" -w "${WORDLIST}" --insecuressl | tee -a "${output_file}"

        if [[ $? -ne 0 ]]; then
            warning "Gobuster scan failed for ${url}. Continuing with the next target."
        else
            pass "Results saved to ${output_file}."
        fi
    done < "${WEB_TARGETS_FILE}"

    pass "Gobuster scans completed for all targets."
}
