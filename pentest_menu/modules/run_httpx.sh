#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "DATA_DIR" "TEE_DIR"

# Define the input file
WEB_TARGETS_FILE="${DATA_DIR}/web.txt"

# Check if the web targets file exists
validate_file_exists "${WEB_TARGETS_FILE}"

info "Running HTTPX on web targets from ${WEB_TARGETS_FILE}..."

# Define output files
HTTPX_OUTPUT_LOG="${TEE_DIR}/HTTPX_results_$(date +"%Y-%m-%d_%H-%M-%S").log"
HTTPX_OUTPUT_TEE="${TEE_DIR}/HTTPX_output.tee"

# Run HTTPX with default options
httpx -silent -l "${WEB_TARGETS_FILE}" -o "${HTTPX_OUTPUT_LOG}" | tee -a "${HTTPX_OUTPUT_TEE}"

if [[ $? -ne 0 ]]; then
    fail "HTTPX execution failed. Check your environment and input file."
    exit 1
fi

info "HTTPX results saved to:"
info "  - Log file: ${HTTPX_OUTPUT_LOG}"
info "  - Detailed output: ${HTTPX_OUTPUT_TEE}"

success "HTTPX scan completed successfully."
