#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "TOOLS_DIR" "DATA_DIR" "CREDS_DIR"

# Define file paths
EXCLUDES_FILE="${DATA_DIR}/excludes.txt"
LIVE_HOSTS_FILE="${TOOLS_DIR}/spoonmap/all_live_hosts.txt"
OUTPUT_FILE="${CREDS_DIR}/default_creds"

# Check if the live hosts file exists
validate_file_exists "${LIVE_HOSTS_FILE}"

# Set up Nmap arguments
NMAP_ARGS="--script http-default-accounts --script-args http-default-accounts.fingerprintfile=${TOOLS_DIR}/nndefaccts/http-default-accounts-fingerprints-nndefaccts.lua"
TARGET_PORTS="80,443,4243,7000,8000,8001,8008,8080,8443,9000"

# Run Nmap with or without exclusion file
if [[ -f "${EXCLUDES_FILE}" ]]; then
    info "Running default credential scan with excludes from ${EXCLUDES_FILE}..."
    nmap -v -v --open --excludefile "${EXCLUDES_FILE}" "${NMAP_ARGS}" -p "${TARGET_PORTS}" -iL "${LIVE_HOSTS_FILE}" -oA "${OUTPUT_FILE}"
else
    info "Running default credential scan without excludes..."
    nmap -v -v --open "${NMAP_ARGS}" -p "${TARGET_PORTS}" -iL "${LIVE_HOSTS_FILE}" -oA "${OUTPUT_FILE}"
fi

if [[ $? -ne 0 ]]; then
    fail "Default credential scan failed."
    exit 1
fi

success "Default credential scan completed. Results saved to ${OUTPUT_FILE}."
