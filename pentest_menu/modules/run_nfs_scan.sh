#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_nfs_scan.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_nfs_scan"]="internal"

# Main function
function run_nfs_scan() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("PORTSCAN_DIR" "OUTPUT_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files
    local _output_dirs
    _input_files=("${PORTSCAN_DIR}/NMAP/2049.txt")
    _output_dirs=("${SHARES_DIR}/NFS")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "nmap" "showmount"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define the input file for port 2049
    PORT_FILE="${PORTSCAN_DIR}/NMAP/2049.txt"

    info "Running Nmap to check for open NFS shares on ports 111 and 2049..."
    nmap -v -v --open -p 111,2049 -sV --script=nfs-showmount,nfs-ls -iL "${PORT_FILE}" -oA "${SHARES_DIR}/NFS/nfs"

    if [[ $? -ne 0 ]]; then
        fail "Nmap scan for NFS shares failed."
        return
    fi

    # Perform showmount for each host in the port file
    info "Checking showmount for hosts listed in ${PORT_FILE}..."
    while IFS= read -r host; do
        info "Running showmount for ${host}..."
        showmount -e "${host}" >> "${SHARES_DIR}/NFS/SHOWMOUNT.tee" 2>&1
        if [[ $? -ne 0 ]]; then
            warn "Failed to retrieve mount information for ${host}."
        fi
    done < "${PORT_FILE}"

    pass "NFS scan completed. Results saved to ${SHARES_DIR}/NFS/SHOWMOUNT.tee."
}
