#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "NMAP_DIR" "DATA_DIR" "TEE_DIR"

# Define the input file for port 2049
PORT_FILE="${NMAP_DIR}/2049.txt"

# Check if the input file exists
validate_file_exists "${PORT_FILE}"

info "Running Nmap to check for open NFS shares on ports 111 and 2049..."
nmap -v -v --open -p 111,2049 -sV --script=nfs-showmount,nfs-ls -iL "${PORT_FILE}" -oA "${DATA_DIR}/SHARES/NFS/nfs"

if [[ $? -ne 0 ]]; then
    fail "Nmap scan for NFS shares failed."
    exit 1
fi

# Perform showmount for each host in the port file
info "Checking showmount for hosts listed in ${PORT_FILE}..."
while IFS= read -r host; do
    info "Running showmount for ${host}..."
    showmount -e "${host}" >> "${TEE_DIR}/SHOWMOUNT.tee" 2>&1
    if [[ $? -ne 0 ]]; then
        warning "Failed to retrieve mount information for ${host}."
    fi
done < "${PORT_FILE}"

success "NFS scan completed. Results saved to ${TEE_DIR}/SHOWMOUNT.tee."
