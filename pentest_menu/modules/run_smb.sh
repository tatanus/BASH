#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "NMAP_DIR" "DATA_DIR" "TEE_DIR"

# Define the input file for port 445
PORT_FILE="${NMAP_DIR}/445.txt"

# Check if the input file exists
validate_file_exists "${PORT_FILE}"

info "Running SMB signing check on targets in ${PORT_FILE}..."
nmap -p 445 --script smb2-security-mode --open -iL "${PORT_FILE}" | tee "${TEE_DIR}/SIGNING.tee"

if [[ $? -ne 0 ]]; then
    fail "SMB signing check failed."
    exit 1
fi

info "Extracting hosts with 'SMB signing not required'..."
grep -B 10 "not required" "${TEE_DIR}/SIGNING.tee" | awk '{match($0,/[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/); ip = substr($0,RSTART,RLENGTH); print ip}' | awk '!/^$/' > "${DATA_DIR}/smb_signing_targets.txt"

info "Enumerating open SMB shares..."
nmap -p 445 -iL "${PORT_FILE}" --script smb-enum-shares -oA "${SHARES_DIR}/SMB/smb_shares"

info "Scanning for SMB vulnerabilities..."
nmap -sV -v -v -p 445,139,3389,1433 --script smb-vuln* -iL "${PORT_FILE}" -oA "${DATA_DIR}/SMB/smb_vuln"

success "SMB scans completed. Results saved to ${DATA_DIR} and ${SHARES_DIR}."
