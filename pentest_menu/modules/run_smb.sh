#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_smb.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_smb"]="internal"

# Main function
function run_smb() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local env_vars=("TEE_DIR" "DATA_DIR" "SHARES_DIR")
    validate_envs "${env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local input_files=("${NMAP_DIR}/445.txt")
    local output_dirs=("${DATA_DIR}" "${SHARES_DIR}")
    validate_input_output input_files output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "nmap" "grep" "tee" "awk"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define the input file for port 445
    PORT_FILE="${NMAP_DIR}/445.txt"

    info "Running SMB signing check on targets in ${PORT_FILE}..."
    nmap -p 445 --script smb2-security-mode --open -iL "${PORT_FILE}" | tee "${TEE_DIR}/SIGNING.tee"

    info "Extracting hosts with 'SMB signing not required'..."
    grep -B 10 "not required" "${TEE_DIR}/SIGNING.tee" | awk '{match($0,/[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/); ip = substr($0,RSTART,RLENGTH); print ip}' | awk '!/^$/' > "${DATA_DIR}/smb_signing_targets.txt"

    info "Enumerating open SMB shares..."
    nmap -p 445 -iL "${PORT_FILE}" --script smb-enum-shares -oA "${SHARES_DIR}/SMB/smb_shares"

    info "Scanning for SMB vulnerabilities..."
    nmap -sV -v -v -p 445,139,3389,1433 --script smb-vuln* -iL "${PORT_FILE}" -oA "${DATA_DIR}/SMB/smb_vuln"

    pass "SMB scans completed. Results saved to ${DATA_DIR} and ${SHARES_DIR}."
}
