#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_nuclei.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_nuclei"]="internal external web"

# Main function
function run_nuclei() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("RECON_DIR" "OUTPUT_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files
    local _output_dirs
    _input_files=("${RECON_DIR}/web.txt")
    _output_dirs=("${OUTPUT_DIR}/WEB")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "nuclei" "tee"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define the input file
    WEB_TARGETS_FILE="${RECON_DIR}/web.txt"

    # Define Nuclei tags
    nuclei_tags=("cves" "default-logins" "exposed-panels" "exposures" "misconfiguration" "network" "takeovers" "vulnerabilities" "full")

    info "Running Nuclei scans on web targets from ${WEB_TARGETS_FILE}..."
    for tag in "${nuclei_tags[@]}"; do
        output_log="${OUTPUT_DIR}/WEB/nuclei_${tag}_$(date +"%Y-%m-%d_%H-%M-%S").log"
        output_tee="${OUTPUT_DIR}/WEB/NUCLEI_${tag}_$(date +"%Y-%m-%d_%H-%M-%S").tee"

        info "Running Nuclei with tag: ${tag}..."
        if [[ "${tag}" == "full" ]]; then
            # shellcheck disable=SC2002
            cat "${WEB_TARGETS_FILE}" | nuclei -ni -o "${output_log}" | tee -a "${output_tee}"
            # shellcheck disable=SC2002
            cat "${WEB_TARGETS_FILE}" | nuclei -ni -t "${tag}" -o "${output_log}" | tee -a "${output_tee}"
        fi

        if [[ $? -ne 0 ]]; then
            warning "Nuclei scan failed for tag ${tag}."
        else
            pass "Results for ${tag} saved to ${output_log} and ${output_tee}."
        fi
    done

    pass "Nuclei scans completed for all tags."
}
