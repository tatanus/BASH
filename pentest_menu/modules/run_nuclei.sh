#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "DATA_DIR" "TEE_DIR"

# Define the input file
WEB_TARGETS_FILE="${DATA_DIR}/web.txt"

# Check if the web targets file exists
validate_file_exists "${WEB_TARGETS_FILE}"

# Define Nuclei tags
nuclei_tags=("cves" "default-logins" "exposed-panels" "exposures" "misconfiguration" "network" "takeovers" "vulnerabilities" "full")

info "Running Nuclei scans on web targets from ${WEB_TARGETS_FILE}..."
for tag in "${nuclei_tags[@]}"; do
    output_log="${DATA_DIR}/WEB/nuclei_${tag}_$(date +"%Y-%m-%d_%H-%M-%S").log"
    output_tee="${TEE_DIR}/NUCLEI_${tag}_$(date +"%Y-%m-%d_%H-%M-%S").tee"

    info "Running Nuclei with tag: ${tag}..."
    if [[ "${tag}" == "full" ]]; then
        # shellcheck disable=SC2002
        cat "${WEB_TARGETS_FILE}" | nuclei -ni -o "${output_log}" | tee -a "${output_tee}"
    else
        # shellcheck disable=SC2002
        cat "${WEB_TARGETS_FILE}" | nuclei -ni -t "${tag}" -o "${output_log}" | tee -a "${output_tee}"
    fi

    if [[ $? -ne 0 ]]; then
        warning "Nuclei scan failed for tag ${tag}."
    else
        success "Results for ${tag} saved to ${output_log} and ${output_tee}."
    fi
done

success "Nuclei scans completed for all tags."
