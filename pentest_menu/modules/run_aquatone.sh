#!/usr/bin/env bash
set -uo pipefail

# =============================================================================
# NAME        : run_aquatone.sh
# DESCRIPTION :
# AUTHOR      : Adam Compton
# DATE CREATED: 2024-12-09 13:49:51
# =============================================================================
# EDIT HISTORY:
# DATE                 | EDITED BY    | DESCRIPTION OF CHANGE
# ---------------------|--------------|----------------------------------------
# 2024-12-09 13:49:51  | Adam Compton | Initial creation.
# =============================================================================

# Define script categories
script_categories["run_aquatone"]="external internal web"

# Define an approximate ordering
script_order["run_aquatone"]=40

# Main function
function run_aquatone() {
    # =============================================================================
    # Step 1: Validate environment variables
    # =============================================================================
    local _env_vars
    _env_vars=("RECON_DIR" "TEE_DIR")
    validate_envs "${_env_vars[@]}" || return 1

    # =============================================================================
    # Step 2: Validate input files and output directories
    # =============================================================================
    local _input_files _output_dirs
    _input_files=("${RECON_DIR}/web.txt")
    _output_dirs=("${TEE_DIR}")
    validate_input_output _input_files _output_dirs || return 1

    # =============================================================================
    # Step 3: Validate any needed tools exist
    # =============================================================================
    validate_tools "aquatone" "cat" "tee"

    # =============================================================================
    # Step 4: Main logic
    # =============================================================================
    # Define the input file
    local WEB_TARGETS_FILE="${RECON_DIR}/web.txt"
    local HTTPX_OUTPUT="${TEE_DIR}/HTTPX_output.tee"

    if is_file_non_empty "${HTTPX_OUTPUT}"; then
        WEB_TARGETS_FILE="${HTTPX_OUTPUT}"
        info "Using HTTPX output file as WEB_TARGETS_FILE: ${WEB_TARGETS_FILE}"
    else
        WEB_TARGETS_FILE="${DEFAULT_WEB_TARGETS}"
        info "Using default web targets file: ${WEB_TARGETS_FILE}"
    fi

    info "Running Aquatone on web targets from ${WEB_TARGETS_FILE}..."
    # shellcheck disable=SC2002
    cat "${WEB_TARGETS_FILE}" | aquatone -scan-timeout 10000 -threads 15 | tee -a "${TEE_DIR}/AQUATONE.tee"

    if [[ $? -ne 0 ]]; then
        fail "Aquatone execution failed."
        return
    fi

    pass "Aquatone completed. Results saved to ${TEE_DIR}/AQUATONE.tee."
}
