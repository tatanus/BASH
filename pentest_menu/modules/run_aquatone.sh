#!/usr/bin/env bash
set -uo pipefail

# Source utility functions and config files from module.sh
source "${SCRIPT_DIR}/lib/module.sh"

# Ensure required environment variables are set
validate_env_vars "DATA_DIR" "TEE_DIR"

# Define the input file
WEB_TARGETS_FILE="${DATA_DIR}/web.txt"

# Check if the input file exists
validate_file_exists "${WEB_TARGETS_FILE}"

info "Running Aquatone on web targets from ${WEB_TARGETS_FILE}..."
# shellcheck disable=SC2002
cat "${WEB_TARGETS_FILE}" | aquatone -scan-timeout 10000 -threads 15 | tee -a "${TEE_DIR}/AQUATONE.tee"

if [[ $? -ne 0 ]]; then
    fail "Aquatone execution failed."
    exit 1
fi

success "Aquatone completed. Results saved to ${TEE_DIR}/AQUATONE.tee."
